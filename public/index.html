<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LivestockMart - User Home</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

        body {
            font-family: "Inter", sans-serif;
        }

        /* Hide scrollbars */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Page fade animation */
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-animated {
            animation: fadeInUp 0.45s ease-out both;
        }

        /* Card hover animation */
        .card-animate {
            transition: all 0.25s ease;
        }
        .card-animate:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 18px 35px rgba(20, 20, 20, 0.15);
        }

        /* Auth glass UI */
        .auth-glass {
            background: rgba(17, 24, 39, 0.85);
            backdrop-filter: blur(18px);
            box-shadow: 0 15px 60px rgba(0, 0, 0, 0.6);
        }

        /* Auth animation */
        .auth-panel {
            transition: transform 0.45s ease, opacity 0.45s ease;
        }
        .auth-panel-register {
            position: absolute;
            inset: 0;
            opacity: 0;
            transform: translateX(100%);
        }
        .auth-card.show-register .auth-panel-login {
            transform: translateX(-100%);
            opacity: 0;
        }
        .auth-card.show-register .auth-panel-register {
            transform: translateX(0);
            opacity: 1;
        }

        /* Animated background */
        @keyframes bgFlow {
            0% {
                background-position: 0% 0%;
            }
            50% {
                background-position: 100% 100%;
            }
            100% {
                background-position: 0% 0%;
            }
        }

        .auth-bg-animated {
            background: radial-gradient(circle at 0% 0%, rgba(52, 211, 153, 0.4), transparent 60%),
                radial-gradient(circle at 100% 0%, rgba(59, 130, 246, 0.35), transparent 60%),
                radial-gradient(circle at 50% 100%, rgba(236, 72, 153, 0.25), transparent 60%),
                #020617;
            background-size: 140% 140%;
            animation: bgFlow 18s ease-in-out infinite alternate;
        }

        /* Prevent login flicker */
        body.preload #auth-screen,
        body.preload #user-app {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-screen preload">

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-3 pointer-events-none"></div>

    <!-- Address Modal -->
    <div
        id="address-modal"
        class="fixed inset-0 z-40 hidden items-center justify-center bg-black/60"
    >
        <div class="bg-white rounded-2xl p-6 w-full max-w-md text-gray-800 shadow-xl section-animated">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Shipping Address</h3>
                <button onclick="closeAddressModal()">
                    <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>

            <form id="address-form" class="space-y-3" onsubmit="saveAddress(event)">
                <div>
                    <label class="text-xs font-semibold text-gray-600">Full Name</label>
                    <input id="addr-name" required class="input-field" />
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-600">Phone</label>
                    <input
                        id="addr-phone"
                        type="tel"
                        maxlength="10"
                        pattern="[0-9]{10}"
                        required
                        class="input-field"
                    />
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-600">Address Line 1</label>
                    <input id="addr-line1" required class="input-field" />
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-600">City</label>
                    <input id="addr-city" required class="input-field" />
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-600">State</label>
                    <input id="addr-state" required class="input-field" />
                </div>

                <div>
                    <label class="text-xs font-semibold text-gray-600">Pincode</label>
                    <input
                        id="addr-pincode"
                        type="tel"
                        maxlength="6"
                        pattern="[0-9]{6}"
                        required
                        class="input-field"
                    />
                </div>

                <div class="mt-4 flex justify-end gap-3">
                    <button
                        type="button"
                        onclick="closeAddressModal()"
                        class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700"
                    >
                        Cancel
                    </button>
                    <button
                        type="submit"
                        class="px-4 py-2 rounded-lg bg-emerald-600 text-white"
                    >
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <div
        id="auth-screen"
        class="hidden fixed inset-0 z-30 flex items-center justify-center px-4 auth-bg-animated"
    >
        <div
            class="max-w-5xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch section-animated"
        >
            <!-- Left Welcome Section -->
            <div class="hidden md:flex flex-col justify-between text-white">
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <div
                            class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-lg font-bold"
                        >
                            L
                        </div>
                        <span class="text-2xl font-bold tracking-tight">LivestockMart</span>
                    </div>
                    <h1 class="text-3xl font-bold leading-tight mb-3">
                        Manage goats & sheep effortlessly.
                    </h1>
                    <p class="text-sm text-emerald-100/80">
                        Smart shopping, fast checkout & friendly UI.
                    </p>
                </div>
            </div>

            <!-- Right Auth Card -->
            <div
                id="auth-card"
                class="auth-card auth-glass rounded-3xl p-6 sm:p-8 border border-white/10 relative"
            >
                <!-- LOGIN PANEL -->
                <div class="auth-panel auth-panel-login">
                    <h2 class="text-xl font-bold text-white mb-6">Welcome Back</h2>

                    <form id="login-form" class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-300">Email</label>
                            <input
                                id="login-email"
                                type="email"
                                required
                                class="input-auth"
                                placeholder="you@example.com"
                            />
                        </div>

                        <div>
                            <label class="text-xs text-gray-300">Password</label>
                            <input
                                id="login-password"
                                type="password"
                                required
                                class="input-auth"
                                placeholder="••••••••"
                            />
                        </div>

                        <button
                            type="submit"
                            class="btn-auth bg-emerald-500 hover:bg-emerald-600"
                        >
                            Login
                        </button>
                    </form>

                    <p class="text-xs text-gray-300 mt-4">
                        New user?
                        <button
                            onclick="switchAuth('register')"
                            class="text-emerald-400 hover:underline"
                        >
                            Create account
                        </button>
                    </p>
                </div>

                <!-- REGISTER PANEL -->
                <div class="auth-panel auth-panel-register">
                    <h2 class="text-xl font-bold text-white mb-6">Create Account</h2>

                    <form id="register-form" class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-300">Full Name</label>
                            <input id="reg-name" required class="input-auth" />
                        </div>

                        <div>
                            <label class="text-xs text-gray-300">Email</label>
                            <input
                                id="reg-email"
                                type="email"
                                required
                                class="input-auth"
                            />
                        </div>

                        <div>
                            <label class="text-xs text-gray-300">Password</label>
                            <input
                                id="reg-password"
                                type="password"
                                required
                                class="input-auth"
                            />
                        </div>

                        <button
                            type="submit"
                            class="btn-auth bg-emerald-500 hover:bg-emerald-600"
                        >
                            Register
                        </button>
                    </form>

                    <p class="text-xs text-gray-300 mt-4">
                        Already have an account?
                        <button
                            onclick="switchAuth('login')"
                            class="text-emerald-400 hover:underline"
                        >
                            Login
                        </button>
                    </p>
                </div>

                <p id="auth-error" class="hidden text-red-300 text-xs mt-4"></p>
            </div>
        </div>
    </div>     <!-- MAIN USER APP -->
    <div id="user-app" class="hidden h-screen flex overflow-hidden">

        <!-- SIDEBAR -->
        <aside class="w-64 bg-gray-800 text-gray-200 p-6 space-y-6 hide-scrollbar overflow-y-auto">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-emerald-500 rounded-full flex items-center justify-center text-lg font-bold">
                    L
                </div>
                <span class="text-xl font-bold">LivestockMart</span>
            </div>

            <nav class="space-y-3">
                <button onclick="switchView('home')" class="nav-btn">
                    <i data-lucide="home"></i> My Home
                </button>

                <button onclick="switchView('browse')" class="nav-btn">
                    <i data-lucide="search"></i> Browse Livestock
                </button>

                <button onclick="switchView('wishlist')" class="nav-btn">
                    <i data-lucide="heart"></i> Wishlist
                </button>

                <button onclick="switchView('cart')" class="nav-btn">
                    <i data-lucide="shopping-cart"></i> Shopping Cart
                </button>

                <button onclick="switchView('orders')" class="nav-btn">
                    <i data-lucide="receipt"></i> My Orders
                </button>

                <button onclick="switchView('addresses')" class="nav-btn">
                    <i data-lucide="map-pin"></i> Addresses
                </button>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 bg-gray-900 overflow-y-auto hide-scrollbar p-6 space-y-6">

            <!-- HEADER -->
            <header class="flex items-center justify-between bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 id="page-title" class="text-xl font-semibold">My Home</h2>

                <div class="relative">
                    <button onclick="toggleProfileMenu()" class="flex items-center gap-2">
                        <div class="w-9 h-9 rounded-full bg-emerald-500 flex items-center justify-center text-white font-bold">
                            <span id="profile-initial">U</span>
                        </div>
                        <i data-lucide="chevron-down" class="text-gray-300"></i>
                    </button>

                    <div
                        id="profile-menu"
                        class="hidden absolute right-0 mt-2 bg-gray-700 rounded-lg shadow-xl overflow-hidden w-40 text-sm z-50"
                    >
                        <div class="px-4 py-2 text-gray-200 border-b border-gray-600 font-semibold">
                            <span id="profile-name">User</span>
                        </div>
                        <button
                            onclick="logout()"
                            class="w-full px-4 py-2 text-left text-red-400 hover:bg-gray-600"
                        >
                            Logout
                        </button>
                    </div>
                </div>
            </header>

            <!-- DASHBOARD HOME -->
            <section id="home-view" class="section-animated">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">

                    <!-- Total Livestock -->
                    <div class="bg-gray-800 p-6 rounded-xl card-animate">
                        <p class="text-gray-400">Total Livestock</p>
                        <h3 id="total-livestock" class="text-3xl font-bold mt-2">0</h3>
                    </div>

                    <!-- Wishlist Count -->
                    <div class="bg-gray-800 p-6 rounded-xl card-animate">
                        <p class="text-gray-400">Wishlist Items</p>
                        <h3 id="wishlist-count" class="text-3xl font-bold mt-2">0</h3>
                    </div>

                    <!-- Cart Count -->
                    <div class="bg-gray-800 p-6 rounded-xl card-animate">
                        <p class="text-gray-400">Cart Items</p>
                        <h3 id="cart-count" class="text-3xl font-bold mt-2">0</h3>
                    </div>

                    <!-- Total Spent -->
                    <div class="bg-gray-800 p-6 rounded-xl card-animate col-span-1 sm:col-span-3">
                        <p class="text-gray-400">Total Spent (INR)</p>
                        <h3 id="total-spent" class="text-3xl font-bold mt-2">₹0</h3>
                    </div>

                </div>
            </section>

            <!-- BROWSE LIVESTOCK -->
            <section id="browse-view" class="hidden section-animated">
                <h3 class="text-lg font-semibold mb-4">Available Livestock</h3>

                <div id="browse-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- WISHLIST -->
            <section id="wishlist-view" class="hidden section-animated">
                <h3 class="text-lg font-semibold mb-4">Your Wishlist</h3>

                <div id="wishlist-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- CART -->
            <section id="cart-view" class="hidden section-animated">
                <h3 class="text-lg font-semibold mb-4">Shopping Cart</h3>

                <div id="cart-list" class="space-y-4"></div>

                <button
                    onclick="proceedToCheckout()"
                    class="mt-6 w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-xl text-white font-semibold"
                >
                    Proceed to Checkout
                </button>
            </section>

            <!-- ORDERS -->
            <section id="orders-view" class="hidden section-animated">
                <h3 class="text-lg font-semibold mb-4">My Orders</h3>

                <div id="orders-list" class="space-y-4"></div>
            </section>

            <!-- ADDRESSES -->
            <section id="addresses-view" class="hidden section-animated">
                <h3 class="text-lg font-semibold mb-4">My Addresses</h3>

                <div id="addresses-list" class="space-y-4"></div>

                <button
                    onclick="openAddressModal()"
                    class="mt-4 bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-white"
                >
                    Add New Address
                </button>
            </section>

        </main>
    </div>
     <script>
        const API_BASE = "/api";

        let currentUser = null;
        let livestockData = [];
        let userState = {
            cart: [],
            wishlist: [],
            addresses: []
        };
        let orders = [];
        let pendingCheckoutItems = null;

        // Inject CSS for custom utility classes
        (function injectCustomStyles() {
            const css = `
            .nav-btn {
                @apply w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-gray-300 hover:bg-gray-700 transition;
            }
            .nav-btn-active {
                @apply bg-emerald-600 text-white;
            }
            .input-auth {
                @apply w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500;
            }
            .input-field {
                @apply w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500;
            }
            .btn-auth {
                @apply w-full mt-4 py-2.5 rounded-xl text-sm font-semibold text-white flex items-center justify-center;
            }
            `;
            // Tailwind's @apply won't be processed at runtime, so fallback manual classes:
            const cssFallback = `
            .nav-btn {
                width: 100%;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0.75rem;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                color: #e5e7eb;
                transition: background-color 0.2s ease, color 0.2s ease;
            }
            .nav-btn i {
                width: 1rem;
                height: 1rem;
            }
            .nav-btn:hover {
                background-color: #374151;
            }
            .nav-btn-active {
                background-color: #059669;
                color: #ffffff;
            }
            .input-auth {
                width: 100%;
                border-radius: 0.75rem;
                border: 1px solid #4b5563;
                background: rgba(15, 23, 42, 0.9);
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                color: #f9fafb;
            }
            .input-field {
                width: 100%;
                border-radius: 0.5rem;
                border: 1px solid #d1d5db;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .btn-auth {
                width: 100%;
                margin-top: 1rem;
                padding: 0.625rem 0.75rem;
                border-radius: 0.75rem;
                font-size: 0.875rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #ffffff;
            }
            `;
            const style = document.createElement("style");
            style.textContent = cssFallback;
            document.head.appendChild(style);
        })();

        // --- Toast helper ---
        function showToast(message, type = "info") {
            const container = document.getElementById("toast-container");
            if (!container) return;

            const id = "toast-" + Date.now();
            const toast = document.createElement("div");
            toast.id = id;
            toast.className =
                "pointer-events-auto max-w-xs w-full rounded-xl shadow-lg px-4 py-3 text-sm flex items-start gap-3 transform transition-all duration-200";

            let bg = "bg-gray-800 text-white";
            if (type === "success") bg = "bg-emerald-600 text-white";
            if (type === "error") bg = "bg-red-600 text-white";
            if (type === "warning") bg = "bg-yellow-500 text-black";

            toast.className += " " + bg;

            toast.innerHTML = `
                <div class="mt-0.5">
                    <i data-lucide="info" class="w-4 h-4"></i>
                </div>
                <div class="flex-1">${message}</div>
                <button onclick="document.getElementById('${id}')?.remove()" class="ml-2 text-xs opacity-80 hover:opacity-100">
                    ✕
                </button>
            `;

            container.appendChild(toast);
            if (window.lucide) lucide.createIcons();

            setTimeout(() => {
                toast.classList.add("opacity-0", "translate-x-2");
                setTimeout(() => toast.remove(), 200);
            }, 3000);
        }

        // --- API helper ---
        async function api(path, options = {}) {
            const config = {
                method: options.method || "GET",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json",
                    ...(options.headers || {})
                }
            };

            if (options.body) {
                config.body =
                    typeof options.body === "string"
                        ? options.body
                        : JSON.stringify(options.body);
            }

            const res = await fetch(API_BASE + path, config);
            if (!res.ok) {
                const text = await res.text().catch(() => "");
                throw new Error(text || "API error");
            }
            const ct = res.headers.get("content-type") || "";
            if (ct.includes("application/json")) {
                return await res.json();
            }
            return null;
        }

        // --- Format INR ---
        function formatINR(value) {
            const num = Number(value) || 0;
            return "₹" + num.toLocaleString("en-IN");
        }

        // --- AUTH UI LOGIC ---

        function switchAuth(mode) {
            const card = document.getElementById("auth-card");
            if (!card) return;
            if (mode === "register") {
                card.classList.add("show-register");
            } else {
                card.classList.remove("show-register");
            }
        }

        function showAuthScreen() {
            document.getElementById("auth-screen").classList.remove("hidden");
            document.getElementById("user-app").classList.add("hidden");
        }

        function showUserApp() {
            document.getElementById("auth-screen").classList.add("hidden");
            document.getElementById("user-app").classList.remove("hidden");
        }

        function setAuthError(msg) {
            const el = document.getElementById("auth-error");
            if (!el) return;
            if (!msg) {
                el.classList.add("hidden");
                el.textContent = "";
            } else {
                el.classList.remove("hidden");
                el.textContent = msg;
                showToast(msg, "error");
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            setAuthError("");

            const email = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value.trim();

            if (!email || !password) {
                setAuthError("Please enter email and password.");
                return;
            }

            try {
                const data = await api("/auth/login", {
                    method: "POST",
                    body: { email, password }
                });
                currentUser = data.user;
                await afterAuthLogin();
                showToast("Logged in successfully.", "success");
            } catch (err) {
                console.error(err);
                setAuthError("Login failed. Check your credentials.");
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            setAuthError("");

            const name = document.getElementById("reg-name").value.trim();
            const email = document.getElementById("reg-email").value.trim();
            const password = document.getElementById("reg-password").value.trim();

            if (!name || !email || !password) {
                setAuthError("All fields are required.");
                return;
            }

            try {
                const data = await api("/auth/register", {
                    method: "POST",
                    body: { name, email, password }
                });
                currentUser = data.user;
                await afterAuthLogin();
                showToast("Account created and logged in.", "success");
            } catch (err) {
                console.error(err);
                setAuthError("Registration failed. Try a different email.");
            }
        }

        async function logout() {
            try {
                await api("/auth/logout", { method: "POST" });
            } catch (err) {
                console.error("Logout error", err);
            }
            currentUser = null;
            userState = { cart: [], wishlist: [], addresses: [] };
            orders = [];
            livestockData = [];
            showToast("Logged out.", "info");
            showAuthScreen();
            updateNavActive("home");
            switchView("home");
        }

        async function checkAuth() {
            try {
                const data = await api("/auth/me");
                currentUser = data.user;
                await afterAuthLogin();
            } catch (err) {
                console.log("Not logged in");
                showAuthScreen();
            } finally {
                document.body.classList.remove("preload");
            }
        }

        async function afterAuthLogin() {
            updateProfileUI();
            showUserApp();
            await loadAllData();
            updateNavActive("home");
            switchView("home");
        }

        function updateProfileUI() {
            const name = currentUser?.name || "User";
            const initial = name.trim().charAt(0).toUpperCase();
            const profileInitial = document.getElementById("profile-initial");
            const profileName = document.getElementById("profile-name");
            if (profileInitial) profileInitial.textContent = initial || "U";
            if (profileName) profileName.textContent = name;
        }

        // --- NAVIGATION / VIEWS ---

        const VIEW_IDS = ["home", "browse", "wishlist", "cart", "orders", "addresses"];

        const VIEW_TITLES = {
            home: "My Home",
            browse: "Browse Livestock",
            wishlist: "Your Wishlist",
            cart: "Shopping Cart",
            orders: "My Orders",
            addresses: "My Addresses"
        };

        const NAV_INDEX = {
            home: 0,
            browse: 1,
            wishlist: 2,
            cart: 3,
            orders: 4,
            addresses: 5
        };

        function switchView(view) {
            VIEW_IDS.forEach((v) => {
                const section = document.getElementById(v + "-view");
                if (!section) return;
                if (v === view) section.classList.remove("hidden");
                else section.classList.add("hidden");
            });

            const title = document.getElementById("page-title");
            if (title) title.textContent = VIEW_TITLES[view] || "My Home";

            updateNavActive(view);

            // re-render icons after DOM changes
            if (window.lucide) lucide.createIcons();

            // If we switch to certain views, re-render their content
            if (view === "home") {
                updateHomeStats();
            } else if (view === "browse") {
                renderBrowse();
            } else if (view === "wishlist") {
                renderWishlist();
            } else if (view === "cart") {
                renderCart();
            } else if (view === "orders") {
                renderOrders();
            } else if (view === "addresses") {
                renderAddresses();
            }
        }

        function updateNavActive(view) {
            const buttons = document.querySelectorAll(".nav-btn");
            buttons.forEach((btn, idx) => {
                btn.classList.remove("nav-btn-active");
                const targetIndex = NAV_INDEX[view];
                if (typeof targetIndex === "number" && idx === targetIndex) {
                    btn.classList.add("nav-btn-active");
                }
            });
        }

        // Profile menu
        function toggleProfileMenu() {
            const menu = document.getElementById("profile-menu");
            if (!menu) return;
            if (menu.classList.contains("hidden")) {
                menu.classList.remove("hidden");
            } else {
                menu.classList.add("hidden");
            }
        }

        document.addEventListener("click", (e) => {
            const menu = document.getElementById("profile-menu");
            const btn = e.target.closest("#profile-button");
            if (!menu) return;
            const clickedInsideMenu = menu.contains(e.target);
            if (!clickedInsideMenu && !btn) {
                menu.classList.add("hidden");
            }
        });

        // --- DATA LOADING ---

        async function loadAllData() {
            try {
                await Promise.all([loadUserStateFromDB(), loadLivestock(), loadOrders()]);
                updateHomeStats();
                renderBrowse();
                renderWishlist();
                renderCart();
                renderOrders();
                renderAddresses();
            } catch (err) {
                console.error("Error loading data:", err);
                showToast("Error loading data from server.", "error");
            }
        }

        async function loadUserStateFromDB() {
            try {
                const data = await api("/user/state");
                userState = {
                    cart: data.cart || [],
                    wishlist: data.wishlist || [],
                    addresses: data.addresses || []
                };
            } catch (err) {
                console.error("User state load error:", err);
                userState = { cart: [], wishlist: [], addresses: [] };
            }
        }

        async function saveUserStateToDB() {
            try {
                await api("/user/state", {
                    method: "PUT",
                    body: userState
                });
            } catch (err) {
                console.error("User state save error:", err);
                showToast("Could not save your changes. Please try again.", "warning");
            }
        }

        async function loadLivestock() {
            const data = await api("/livestock");
            livestockData = Array.isArray(data) ? data : [];
        }

        async function loadOrders() {
            const data = await api("/orders");
            orders = Array.isArray(data) ? data : [];
        }

        // --- HOME STATS ---

        function updateHomeStats() {
            const totalLivestockEl = document.getElementById("total-livestock");
            const wishlistCountEl = document.getElementById("wishlist-count");
            const cartCountEl = document.getElementById("cart-count");
            const totalSpentEl = document.getElementById("total-spent");

            if (totalLivestockEl) totalLivestockEl.textContent = livestockData.length || 0;
            if (wishlistCountEl) wishlistCountEl.textContent = userState.wishlist.length || 0;
            if (cartCountEl) cartCountEl.textContent = userState.cart.length || 0;

            const totalSpent = orders.reduce((sum, o) => sum + (o.total || 0), 0);
            if (totalSpentEl) totalSpentEl.textContent = formatINR(totalSpent);
        }

        // --- BROWSE RENDER ---

        function renderBrowse() {
            const container = document.getElementById("browse-list");
            if (!container) return;

            if (!livestockData.length) {
                container.innerHTML =
                    '<p class="text-gray-400">No livestock available right now.</p>';
                return;
            }

            container.innerHTML = livestockData
                .map((item) => {
                    const inWishlist = userState.wishlist.includes(String(item._id));
                    return `
                    <div class="bg-gray-800 rounded-xl p-4 flex flex-col gap-3 card-animate">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400">${item.type || ""}</p>
                                <h4 class="text-lg font-semibold">${item.name || "Livestock"}</h4>
                                <p class="text-xs text-gray-400">${item.breed || ""}</p>
                            </div>
                            <button
                                onclick="toggleWishlist('${item._id}')"
                                class="p-2 rounded-full ${
                                    inWishlist ? "bg-red-500 text-white" : "bg-gray-700 text-gray-200"
                                }"
                            >
                                <i data-lucide="heart" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div class="flex items-center justify-between mt-3">
                            <p class="text-xl font-bold text-emerald-400">
                                ${formatINR(item.price || 0)}
                            </p>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button
                                onclick="addToCart('${item._id}')"
                                class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm text-gray-100"
                            >
                                Add to Cart
                            </button>
                            <button
                                onclick="buyNow('${item._id}')"
                                class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg text-sm text-white"
                            >
                                Buy
                            </button>
                        </div>
                    </div>
                `;
                })
                .join("");

            if (window.lucide) lucide.createIcons();
        }

        // --- WISHLIST RENDER ---

        function renderWishlist() {
            const container = document.getElementById("wishlist-list");
            if (!container) return;

            const items = livestockData.filter((x) =>
                userState.wishlist.includes(String(x._id))
            );

            if (!items.length) {
                container.innerHTML =
                    '<p class="text-gray-400">Your wishlist is empty.</p>';
                return;
            }

            container.innerHTML = items
                .map((item) => {
                    return `
                    <div class="bg-gray-800 rounded-xl p-4 card-animate flex flex-col gap-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-semibold">${item.name || "Livestock"}</h4>
                                <p class="text-xs text-gray-400">${item.breed || ""}</p>
                            </div>
                            <button
                                onclick="toggleWishlist('${item._id}')"
                                class="p-2 rounded-full bg-gray-700 text-gray-200 hover:bg-gray-600"
                            >
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-xl font-bold text-emerald-400">
                            ${formatINR(item.price || 0)}
                        </p>
                        <button
                            onclick="addToCart('${item._id}')"
                            class="mt-2 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg text-sm text-gray-100"
                        >
                            Add to Cart
                        </button>
                    </div>
                `;
                })
                .join("");

            if (window.lucide) lucide.createIcons();
        }

        // --- CART RENDER ---

        function renderCart() {
            const container = document.getElementById("cart-list");
            if (!container) return;

            if (!userState.cart.length) {
                container.innerHTML =
                    '<p class="text-gray-400">Your cart is empty.</p>';
                return;
            }

            let totalSelected = 0;

            container.innerHTML = userState.cart
                .map((cartItem, idx) => {
                    const item = livestockData.find(
                        (x) => String(x._id) === String(cartItem.livestockId)
                    );
                    if (!item) return "";

                    const selected = cartItem.selected !== false;
                    if (selected) totalSelected += item.price || 0;

                    return `
                    <div class="bg-gray-800 rounded-xl p-4 flex items-center justify-between gap-4 card-animate">
                        <div class="flex items-center gap-3">
                            <input
                                type="checkbox"
                                ${selected ? "checked" : ""}
                                onchange="toggleCartSelection(${idx}, this.checked)"
                                class="w-4 h-4"
                            />
                            <div>
                                <h4 class="text-sm font-semibold">${item.name || "Livestock"}</h4>
                                <p class="text-xs text-gray-400">${item.breed || ""}</p>
                                <p class="text-sm text-emerald-400 mt-1">
                                    ${formatINR(item.price || 0)}
                                </p>
                            </div>
                        </div>
                        <button
                            onclick="removeFromCart(${idx})"
                            class="p-2 rounded-full bg-red-500 text-white hover:bg-red-600"
                        >
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                })
                .join("");

            // Show total selected at bottom of cart section
            container.insertAdjacentHTML(
                "beforeend",
                `
                <div class="mt-4 flex items-center justify-between">
                    <span class="text-gray-300 text-sm">Total for selected items:</span>
                    <span class="text-lg font-semibold text-emerald-400">${formatINR(
                        totalSelected
                    )}</span>
                </div>
            `
            );

            if (window.lucide) lucide.createIcons();
        }

        // --- ORDERS RENDER ---

        function renderOrders() {
            const container = document.getElementById("orders-list");
            if (!container) return;

            if (!orders.length) {
                container.innerHTML =
                    '<p class="text-gray-400">You have no orders yet.</p>';
                return;
            }

            container.innerHTML = orders
                .map((o) => {
                    const itemsText = (o.items || [])
                        .map((it) => it.name)
                        .join(", ");
                    return `
                    <div class="bg-gray-800 rounded-xl p-4 flex flex-col gap-2 card-animate">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-400">Order #${String(
                                o._id
                            ).slice(-6)}</span>
                            <span class="text-xs px-2 py-1 rounded-full ${
                                o.status === "Delivered"
                                    ? "bg-emerald-600 text-white"
                                    : "bg-yellow-500 text-black"
                            }">
                                ${o.status || "Processing"}
                            </span>
                        </div>
                        <p class="text-sm text-gray-200">${itemsText}</p>
                        <p class="text-sm text-gray-400">${o.date || ""}</p>
                        <p class="text-base font-semibold text-emerald-400">
                            ${formatINR(o.total || 0)}
                        </p>
                    </div>
                `;
                })
                .join("");
        }

        // --- ADDRESSES RENDER ---

        function renderAddresses() {
            const container = document.getElementById("addresses-list");
            if (!container) return;

            if (!userState.addresses.length) {
                container.innerHTML =
                    '<p class="text-gray-400">No saved addresses yet.</p>';
                return;
            }

            container.innerHTML = userState.addresses
                .map((addr, idx) => {
                    return `
                    <div class="bg-gray-800 rounded-xl p-4 flex flex-col gap-2 card-animate">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-gray-400">Name</p>
                                <p class="text-sm font-semibold text-gray-100">${
                                    addr.name || ""
                                }</p>
                            </div>
                            <button
                                class="px-3 py-1 rounded-lg bg-gray-700 text-gray-100 text-xs"
                                onclick="editAddress(${idx})"
                            >
                                Change
                            </button>
                        </div>

                        <p class="text-xs text-gray-400 mt-2">Phone</p>
                        <p class="text-sm text-gray-100">${
                            addr.phone ? "+91 " + addr.phone : ""
                        }</p>

                        <p class="text-xs text-gray-400 mt-2">Address</p>
                        <p class="text-sm text-gray-100">
                            ${addr.line1 || ""}, ${addr.city || ""}, ${addr.state || ""}
                        </p>

                        <p class="text-xs text-gray-400 mt-2">Pincode</p>
                        <p class="text-sm text-gray-100">${addr.pincode || ""}</p>
                    </div>
                `;
                })
                .join("");
        }

        // --- WISHLIST / CART ACTIONS ---

        function toggleWishlist(id) {
            const strId = String(id);
            const idx = userState.wishlist.indexOf(strId);
            if (idx === -1) userState.wishlist.push(strId);
            else userState.wishlist.splice(idx, 1);

            saveUserStateToDB();
            updateHomeStats();
            renderBrowse();
            renderWishlist();
            showToast("Wishlist updated.", "success");
        }

        function addToCart(id) {
            const strId = String(id);
            const exists = userState.cart.some(
                (c) => String(c.livestockId) === strId
            );
            if (exists) {
                showToast("Item is already in cart.", "warning");
                return;
            }
            userState.cart.push({
                livestockId: strId,
                selected: true
            });
            saveUserStateToDB();
            updateHomeStats();
            renderCart();
            showToast("Added to cart.", "success");
        }

        function removeFromCart(index) {
            userState.cart.splice(index, 1);
            saveUserStateToDB();
            updateHomeStats();
            renderCart();
            showToast("Removed from cart.", "info");
        }

        function toggleCartSelection(index, checked) {
            if (!userState.cart[index]) return;
            userState.cart[index].selected = !!checked;
            saveUserStateToDB();
            renderCart();
        }

        function buyNow(id) {
            const strId = String(id);
            const item = livestockData.find((x) => String(x._id) === strId);
            if (!item) {
                showToast("Item not found.", "error");
                return;
            }
            pendingCheckoutItems = [
                {
                    livestockId: strId
                }
            ];
            if (!userState.addresses.length) {
                openAddressModal();
            } else {
                proceedOrderWithAddress(userState.addresses[0]);
            }
        }

        // --- CHECKOUT / ORDERS ---

        function proceedToCheckout() {
            const selectedItems = userState.cart.filter((c) => c.selected !== false);
            if (!selectedItems.length) {
                showToast("Select at least one item in cart.", "warning");
                return;
            }
            pendingCheckoutItems = selectedItems.slice();
            if (!userState.addresses.length) {
                openAddressModal();
            } else {
                proceedOrderWithAddress(userState.addresses[0]);
            }
        }

        function proceedOrderWithAddress(address) {
            if (!pendingCheckoutItems || !pendingCheckoutItems.length) {
                showToast("No items selected.", "warning");
                return;
            }

            const itemsPayload = pendingCheckoutItems
                .map((c) => {
                    const item = livestockData.find(
                        (x) => String(x._id) === String(c.livestockId)
                    );
                    if (!item) return null;
                    return {
                        id: String(item._id),
                        name: item.name,
                        price: item.price,
                        breed: item.breed
                    };
                })
                .filter(Boolean);

            if (!itemsPayload.length) {
                showToast("Selected items are invalid.", "error");
                return;
            }

            const total = itemsPayload.reduce(
                (sum, it) => sum + (it.price || 0),
                0
            );

            const payload = {
                date: new Date().toLocaleDateString("en-IN"),
                items: itemsPayload,
                total,
                status: "Processing",
                address
            };

            api("/orders", {
                method: "POST",
                body: payload
            })
                .then(async () => {
                    // remove purchased from cart
                    const idsBought = new Set(
                        pendingCheckoutItems.map((c) => String(c.livestockId))
                    );
                    userState.cart = userState.cart.filter(
                        (c) => !idsBought.has(String(c.livestockId))
                    );
                    pendingCheckoutItems = null;
                    await saveUserStateToDB();
                    await loadOrders();
                    updateHomeStats();
                    renderCart();
                    renderOrders();
                    switchView("orders");
                    showToast("Order placed successfully!", "success");
                })
                .catch((err) => {
                    console.error(err);
                    showToast("Failed to place order.", "error");
                });
        }

        // --- ADDRESS MODAL / ACTIONS ---

        function openAddressModal() {
            const modal = document.getElementById("address-modal");
            if (!modal) return;

            // If there's at least one address, load the first one for editing
            if (userState.addresses.length) {
                const addr = userState.addresses[0];
                document.getElementById("addr-name").value = addr.name || "";
                document.getElementById("addr-phone").value = addr.phone || "";
                document.getElementById("addr-line1").value = addr.line1 || "";
                document.getElementById("addr-city").value = addr.city || "";
                document.getElementById("addr-state").value = addr.state || "";
                document.getElementById("addr-pincode").value = addr.pincode || "";
            } else {
                document.getElementById("address-form").reset();
            }

            modal.classList.remove("hidden");
            modal.classList.add("flex");
        }

        function closeAddressModal() {
            const modal = document.getElementById("address-modal");
            if (!modal) return;
            modal.classList.add("hidden");
            modal.classList.remove("flex");
        }

        function editAddress(index) {
            // For simplicity, we only support editing the first address as default
            if (!userState.addresses[index]) return;
            openAddressModal();
        }

        function saveAddress(event) {
            event.preventDefault();

            const name = document.getElementById("addr-name").value.trim();
            const phone = document.getElementById("addr-phone").value.trim();
            const line1 = document.getElementById("addr-line1").value.trim();
            const city = document.getElementById("addr-city").value.trim();
            const state = document.getElementById("addr-state").value.trim();
            const pincode = document.getElementById("addr-pincode").value.trim();

            if (!name || !phone || !line1 || !city || !state || !pincode) {
                showToast("Please fill in all address fields.", "warning");
                return;
            }

            if (!/^[0-9]{10}$/.test(phone)) {
                showToast("Phone must be 10 digits.", "warning");
                return;
            }
            if (!/^[0-9]{6}$/.test(pincode)) {
                showToast("Pincode must be 6 digits.", "warning");
                return;
            }

            const newAddr = {
                name,
                phone,
                line1,
                city,
                state,
                pincode
            };

            if (!userState.addresses.length) {
                userState.addresses.push(newAddr);
            } else {
                // Overwrite the first address as the primary
                userState.addresses[0] = newAddr;
            }

            saveUserStateToDB();
            renderAddresses();
            closeAddressModal();
            showToast("Address saved.", "success");

            // If there was a pending checkout, proceed now
            if (pendingCheckoutItems && pendingCheckoutItems.length) {
                proceedOrderWithAddress(newAddr);
            }
        }

        // --- DOM READY ---

        document.addEventListener("DOMContentLoaded", () => {
            // Attach form handlers
            const loginForm = document.getElementById("login-form");
            const regForm = document.getElementById("register-form");
            const addrForm = document.getElementById("address-form");

            if (loginForm) loginForm.addEventListener("submit", handleLogin);
            if (regForm) regForm.addEventListener("submit", handleRegister);
            if (addrForm) addrForm.addEventListener("submit", saveAddress);

            if (window.lucide) lucide.createIcons();

            checkAuth();
        });
    </script>
</body>
</html>
